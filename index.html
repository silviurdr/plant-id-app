<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlantID App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 pb-20">

    <div id="app" class="bg-white shadow-xl rounded-2xl w-full max-w-sm p-6 space-y-6">
        </div>

    <script>
        const PLANTNET_API_KEY = "PLANTNET_KEY_HERE";
        const GEMINI_API_KEY = "GEMINI_KEY_HERE";
        const PLANTNET_API_URL = "https://my-api.plantnet.org/v2/identify/all?api-key=" + PLANTNET_API_KEY;
        const CORS_PROXY_URL = "https://corsproxy.io/?";

        let state = {
            isIdentifying: false,
            identificationResult: null,
            error: null,
            careInstructions: null,
            isGeneratingCare: false,
            selectedImage: null,
            suggestions: [],
        };

        const appContainer = document.getElementById('app');

        function setState(newState) {
            state = { ...state, ...newState };
            render();
        }

        function render() {
            const hasResult = state.identificationResult || state.suggestions.length > 0 || state.error;

            appContainer.innerHTML = `
                <header class="text-center">
                    <h1 class="text-3xl font-bold text-green-700">🌿 PlantID App</h1>
                    <p class="mt-2 text-sm text-gray-500">Identifică plante și copaci cu camera ta.</p>
                </header>
        
                <main class="flex flex-col items-center space-y-4">
                    ${!state.isIdentifying && !hasResult ? `
                        <input type="file" id="image-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" />
                        
                        ${state.selectedImage ? `
                            <img src="${state.selectedImage}" alt="Imaginea selectată" class="w-full h-auto rounded-lg shadow-md mb-4" />
                        ` : ''}

                        <button id="identify-btn" class="w-full px-6 py-3 text-white rounded-xl shadow-lg transition-all duration-300 transform bg-green-600 hover:bg-green-700 active:scale-95"
                            ${state.selectedImage ? '' : 'disabled'}>
                            Identifică planta
                        </button>
                    ` : ''}

                    ${state.isIdentifying ? `
                        <div class="flex items-center space-x-2 text-green-600 animate-pulse">
                            <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Analizând imaginea...</span>
                        </div>
                    ` : ''}
        
                    ${state.error ? `
                        <div class="text-red-500 p-4 bg-red-100 rounded-lg w-full text-center">
                            ${state.error}
                        </div>
                    ` : ''}
        
                    ${state.identificationResult ? `
                        <div class="w-full bg-white rounded-xl shadow-md p-4 mt-4">
                            <h2 class="text-2xl font-semibold text-green-800 border-b-2 border-green-200 pb-2 text-center">
                                ${state.identificationResult.commonName}
                            </h2>
                            <div class="flex flex-col items-center mt-4">
                                <img id="result-img" alt="Imagine of ${state.identificationResult.commonName}" class="rounded-lg shadow-md mb-4 w-full" />
                                <p class="text-sm font-light text-gray-600">
                                    <span class="font-semibold text-gray-700">Nume științific:</span> ${state.identificationResult.scientificName}
                                </p>
                            </div>

                            <div class="flex justify-center w-full mt-6 mb-4">
                                <button id="care-btn" class="px-4 py-2 text-white rounded-xl shadow-lg transition-all duration-300 transform ${state.isGeneratingCare ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 active:scale-95'}"
                                    ${state.isGeneratingCare ? 'disabled' : ''}>
                                    ${state.isGeneratingCare ? 'Se generează...' : '✨ Obține descrierea completă ✨'}
                                </button>
                            </div>

                            ${state.careInstructions ? `
                                <div class="mt-4 bg-green-50 p-4 rounded-lg border border-green-200">
                                    <h3 class="text-md font-bold text-green-800 text-center mb-2">Detalii plantă:</h3>
                                    ${state.careInstructions}
                                </div>
                            ` : ''}
                        </div>
                    ` : ''}

                    ${state.suggestions.length > 0 ? `
                        <div class="w-full bg-yellow-50 rounded-xl shadow-md p-4 mt-4 border border-yellow-200">
                            <h3 class="text-lg font-semibold text-yellow-800 text-center mb-2">Am găsit câteva sugestii:</h3>
                            <ul class="list-disc list-inside space-y-1 text-sm text-yellow-700">
                                ${state.suggestions.map(s => `<li>${s.commonName || s.scientificName} (Scor: ${Math.round(s.score * 100)}%)</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${hasResult || state.error ? `
                        <button id="reset-btn" class="w-full mt-4 px-6 py-3 text-white rounded-xl shadow-lg transition-all duration-300 transform bg-green-600 hover:bg-green-700 active:scale-95 flex items-center justify-center space-x-2">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-white">
                               <path fill-rule="evenodd" d="M19.324 18.026a1.5 1.5 0 00-.765-.39L15 17.5l-.544-2.613a1.5 1.5 0 00-.765-.39c-.931-.193-1.898.419-1.924 1.439l-.368 1.838a1.5 1.5 0 00.765.39L18.5 18.5l.544 2.613a1.5 1.5 0 00.765.39c.931.193 1.898-.419 1.924-1.439l.368-1.838a1.5 1.5 0 00-.765-.39zM19 12.75a6.75 6.75 0 00-11.39-4.808C6.936 8.012 6.133 8.245 5.688 8.8L3.655 11.23a1.875 1.875 0 00.99 3.498l1.096-.328c.455-.137.99-.092 1.341.22l.966.864a1.875 1.875 0 002.585 0l2.63-2.355a1.875 1.875 0 000-2.673l-1.93-2.164a1.875 1.875 0 00-2.316-.279l-1.071.321a1.875 1.875 0 00-1.34-1.616L3.25 4.375A.75.75 0 014 3.75h1.229a1.5 1.5 0 011.06-.44l.87-.271M18.75 6a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                           </svg>
                           <span>Începe o nouă căutare</span>
                        </button>
                    ` : ''}
                </main>
            `;
            
            const imageUpload = document.getElementById('image-upload');
            if (imageUpload) {
                imageUpload.addEventListener('change', handleImageChange);
            }
            
            const identifyButton = document.getElementById('identify-btn');
            if (identifyButton) {
                identifyButton.addEventListener('click', handleIdentifyPlant);
            }
            const resetButton = document.getElementById('reset-btn');
            if (resetButton) {
                resetButton.addEventListener('click', handleReset);
            }

            const careButton = document.getElementById('care-btn');
            if (careButton) {
                careButton.addEventListener('click', handleGetCareInstructions);
            }

            if (state.identificationResult && state.identificationResult.imageUrl) {
                const resultImg = document.getElementById('result-img');
                if (resultImg) {
                    resultImg.src = state.identificationResult.imageUrl;
                }
            }
        }

        function handleImageChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    setState({ ...state, selectedImage: reader.result, identificationResult: null, error: null, suggestions: [], careInstructions: null });
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleIdentifyPlant() {
            if (!state.selectedImage) {
                setState({ ...state, error: "Vă rugăm să selectați o imagine pentru a identifica planta." });
                return;
            }

            setState({ ...state, isIdentifying: true, identificationResult: null, error: null, suggestions: [] });

            try {
                const formData = new FormData();
                const blob = await fetch(state.selectedImage).then(res => res.blob());
                formData.append('images', blob, 'plant.jpg');
                
                const apiResponse = await fetch(CORS_PROXY_URL + encodeURIComponent(PLANTNET_API_URL + '&lang=ro'), {
                    method: 'POST',
                    body: formData,
                });

                if (!apiResponse.ok) {
                    const errorText = await apiResponse.text();
                    throw new Error(`API a returnat status ${apiResponse.status}: ${errorText}`);
                }

                const jsonResponse = await apiResponse.json();

                if (jsonResponse && jsonResponse.results && jsonResponse.results.length > 0) {
                    const bestMatch = jsonResponse.results[0];
                    
                    if (bestMatch.score > 0.3) {
                        const plant = bestMatch.species;
                        const commonNameRo = plant.commonNames?.find(cn => cn.language === 'ro')?.name;
                        const commonNameEn = plant.commonNames?.find(cn => cn.language === 'en')?.name;
                        const commonName = commonNameRo || commonNameEn || plant.scientificName;
                        const description = "Nu există o descriere detaliată în răspunsul API. Folosiți funcția 'Ghid de îngrijire' pentru mai multe informații.";
                        
                        setState({
                            ...state,
                            identificationResult: {
                                commonName,
                                scientificName: plant.scientificName,
                                description,
                                imageUrl: state.selectedImage
                            },
                            isIdentifying: false,
                            suggestions: []
                        });
                    } else {
                        const topSuggestions = jsonResponse.results.slice(0, 5).map(s => ({
                            commonName: s.species.commonNames?.find(cn => cn.language === 'ro')?.name || s.species.scientificName,
                            scientificName: s.species.scientificName,
                            score: s.score
                        }));

                        setState({
                            ...state,
                            error: null,
                            suggestions: topSuggestions,
                            identificationResult: null,
                            isIdentifying: false
                        });
                    }
                } else {
                    const errorText = JSON.stringify(jsonResponse);
                    throw new Error(`API a returnat un răspuns neașteptat: ${errorText}`);
                }
            } catch (e) {
                setState({ ...state, error: `Ceva nu a mers bine: ${e.message}`, isIdentifying: false, suggestions: [] });
                console.error("Identification failed:", e);
            }
        }

        async function handleGetCareInstructions() {
            if (!state.identificationResult) return;
            setState({ ...state, isGeneratingCare: true, careInstructions: null, error: null });

            const prompt = `Generează o descriere detaliată, organizată în secțiuni, pentru planta cu numele științific: ${state.identificationResult.scientificName}. Include informații despre:
**🌿 Descriere Detaliată:** O prezentare generală a aspectului și caracteristicilor.
**🕰️ Istoric și Origine:** De unde provine planta și cum a fost folosită în trecut.
**🌍 Mediu de creștere și habitat:** Condiții ideale de creștere și zone geografice tipice.
**✨ Aspecte interesante:** Curiozități sau fapte mai puțin cunoscute despre plantă.
**💧 Instrucțiuni de îngrijire:** Sfaturi practice pentru îngrijirea acasă (udare, lumină, sol, fertilizare).
Pentru fiecare subtitlu, folosește un tag <h4> pentru a forma secțiuni clare, iar pentru textul din interiorul secțiunilor folosește taguri <p>.
`;
            
            try {
                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    const formattedText = text
                        .replace(/\*\*🌿 Descriere Detaliată:\*\*/g, '<h4 class="flex items-center space-x-2 text-md font-bold text-green-800 mt-4"><span>🌿</span><span>Descriere Detaliată</span></h4>')
                        .replace(/\*\*🕰️ Istoric și Origine:\*\*/g, '<h4 class="flex items-center space-x-2 text-md font-bold text-green-800 mt-4"><span>🕰️</span><span>Istoric și Origine</span></h4>')
                        .replace(/\*\*🌍 Mediu de creștere și habitat:\*\*/g, '<h4 class="flex items-center space-x-2 text-md font-bold text-green-800 mt-4"><span>🌍</span><span>Mediu de creștere și habitat</span></h4>')
                        .replace(/\*\*✨ Aspecte interesante:\*\*/g, '<h4 class="flex items-center space-x-2 text-md font-bold text-green-800 mt-4"><span>✨</span><span>Aspecte interesante</span></h4>')
                        .replace(/\*\*💧 Instrucțiuni de îngrijire:\*\*/g, '<h4 class="flex items-center space-x-2 text-md font-bold text-green-800 mt-4"><span>💧</span><span>Instrucțiuni de îngrijire</span></h4>')
                        .replace(/\n\n/g, '<p></p>');
                        
                    setState({ ...state, careInstructions: formattedText, isGeneratingCare: false });
                } else {
                    setState({ ...state, error: "Nu s-au putut genera instrucțiuni de îngrijire.", isGeneratingCare: false });
                }
            } catch (e) {
                setState({ ...state, error: `Eroare la generarea instrucțiunilor: ${e.message}`, isGeneratingCare: false });
                console.error("Gemini API call failed:", e);
            }
        }

        function handleReset() {
            setState({
                isIdentifying: false,
                identificationResult: null,
                error: null,
                careInstructions: null,
                isGeneratingCare: false,
                selectedImage: null,
                suggestions: [],
            });
            const fileInput = document.getElementById('image-upload');
            if (fileInput) fileInput.value = '';
        }
        
        render();
    </script>
</body>
</html>


